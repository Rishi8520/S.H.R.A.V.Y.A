<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHRAVYA - Advanced Brain Monitoring Interface</title>
    <style>
        /* ========== RESET & BASE STYLES ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        /* ========== CONTAINER & LAYOUT ========== */
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 
                0 20px 50px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            max-width: 1200px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        /* ========== HEADER STYLES ========== */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        .header h1 {
            font-size: clamp(2.5rem, 5vw, 4rem);
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -2px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .tagline {
            font-size: 1.2rem;
            color: #666;
            font-weight: 300;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.95rem;
            color: #888;
            font-style: italic;
        }

        /* ========== BUTTON STYLES ========== */
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            position: relative;
            z-index: 10;
        }

        .control-btn, .test-btn, .voice-btn {
            padding: 18px 30px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-btn::before, .test-btn::before, .voice-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }

        .control-btn:hover::before, .test-btn:hover::before, .voice-btn:hover::before {
            left: 100%;
        }

        .control-btn:hover, .test-btn:hover, .voice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Button Colors */
        .btn-start {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-voice {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        /* ========== STATUS GRID ========== */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #333;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-label {
            color: #666;
            font-size: 0.9rem;
            font-weight: 400;
        }

        /* ========== WELLNESS DISPLAY ========== */
        .wellness-display {
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            color: white;
            text-align: center;
            padding: 40px;
            border-radius: 25px;
            margin-bottom: 40px;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .wellness-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: rotate 8s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .wellness-score {
            font-size: 4.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            position: relative;
            z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .wellness-label {
            font-size: 1.3rem;
            font-weight: 400;
            position: relative;
            z-index: 10;
        }

        /* ========== STATUS DISPLAY ========== */
        .status-display {
            background: rgba(248, 249, 250, 0.95);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(222, 226, 230, 0.5);
            margin-bottom: 30px;
        }

        .status-display div {
            margin: 8px 0;
            font-weight: 600;
            padding: 8px 0;
            border-bottom: 1px solid rgba(222, 226, 230, 0.3);
        }

        .status-display div:last-child {
            border-bottom: none;
        }

        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }

        /* ========== ACTIVITY LOG ========== */
        .activity-log {
            background: rgba(248, 249, 250, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(222, 226, 230, 0.5);
            position: relative;
        }

        .activity-log h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .log-entry, #responseLog {
            padding: 12px 18px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 4px solid #3498db;
            font-size: 0.95rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .log-entry:hover, #responseLog:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateX(5px);
        }

        .log-entry.success { border-left-color: #28a745; color: #155724; }
        .log-entry.warning { border-left-color: #ffc107; color: #856404; }
        .log-entry.error { border-left-color: #dc3545; color: #721c24; }
        .log-entry.info { border-left-color: #17a2b8; color: #0c5460; }

        #responseLog {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.85rem;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid rgba(222, 226, 230, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            background: rgba(248, 249, 250, 0.8);
            backdrop-filter: blur(10px);
        }

        /* ========== AUDIO CONTROLS ========== */
        #responseAudio {
            width: 100%;
            margin: 20px 0;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        /* ========== ANIMATIONS ========== */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .monitoring-active {
            animation: monitoring-glow 3s ease-in-out infinite;
        }

        @keyframes monitoring-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.3); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.6); }
        }

        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .button-group {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .status-grid {
                grid-template-columns: 1fr;
            }

            .wellness-score {
                font-size: 3rem;
            }
        }

        @media (max-width: 480px) {
            .control-btn, .test-btn, .voice-btn {
                padding: 15px 20px;
                font-size: 1rem;
            }
        }

        /* ========== SCROLLBAR STYLING ========== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(241, 241, 241, 0.5);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2, #f093fb);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== HEADER ========== -->
        <div class="header">
            <h1>🧠 SHRAVYA</h1>
            <p class="tagline">She Hears, Responds and Attends to Your Awareness</p>
            <p class="subtitle">Advanced Brain Monitoring & AI Companion Interface</p>
        </div>

        <!-- ========== MAIN CONTROL BUTTONS ========== -->
        <div class="button-group">
            <button id="startMonitoringBtn" class="control-btn btn-start">
                🎯 Start EEG Monitoring
            </button>
            <button id="stopMonitoringBtn" class="control-btn btn-stop">
                ⏹️ Stop Monitoring
            </button>
        </div>

        <!-- ========== VOICE COMMAND BUTTONS ========== -->
        <div class="button-group">
            <button id="startGreetingBtn" class="voice-btn btn-primary">
                👋 Start Greeting
            </button>
            <button id="listenCmdBtn" class="voice-btn btn-primary">
                🎤 Listen to Command
            </button>
        </div>

        <!-- ========== EEG TEST BUTTONS ========== -->
        <div class="button-group">
            <button id="testBasicEEGBtn" class="test-btn btn-success">
                🧪 Test Basic EEG
            </button>
            <button id="testHighStressBtn" class="test-btn btn-warning">
                ⚠️ Test High Stress
            </button>
            <button id="testPerfectFocusBtn" class="test-btn btn-success">
                🎯 Test Perfect Focus
            </button>
            <button id="clearLogBtn" class="test-btn btn-warning">
                🗑️ Clear Log
            </button>
        </div>

        <!-- ========== WELLNESS DISPLAY ========== -->
        <div class="wellness-display">
            <div class="wellness-score" id="wellnessScore">--</div>
            <div class="wellness-label">Overall Wellness Score</div>
        </div>

        <!-- ========== STATUS GRID ========== -->
        <div class="status-grid">
            <div class="status-card">
                <h3>🎯 Focus Level</h3>
                <div class="status-value" id="focusLevel">--</div>
                <div class="status-label">Current focus state</div>
            </div>
            <div class="status-card">
                <h3>😰 Stress Level</h3>
                <div class="status-value" id="stressLevel">--</div>
                <div class="status-label">Current stress state</div>
            </div>
            <div class="status-card">
                <h3>🧘 Calm Level</h3>
                <div class="status-value" id="calmLevel">--</div>
                <div class="status-label">Current calm state</div>
            </div>
            <div class="status-card">
                <h3>⚡ Flow State</h3>
                <div class="status-value" id="flowState">--</div>
                <div class="status-label">Peak performance state</div>
            </div>
            <div class="status-card">
                <h3>📡 Connection</h3>
                <div class="status-value" id="connectionStatus">Offline</div>
                <div class="status-label">Hardware status</div>
            </div>
            <div class="status-card">
                <h3>🔄 Sampling Rate</h3>
                <div class="status-value" id="samplingRate">--</div>
                <div class="status-label">Samples per second</div>
            </div>
        </div>

        <!-- ========== AUDIO PLAYER ========== -->
        <audio id="responseAudio" controls style="width: 100%; margin: 20px 0;"></audio>

        <!-- ========== STATUS DISPLAY ========== -->
        <div class="status-display">
            <div id="connectionStatusDetailed" class="info">Connection Status: Ready</div>
            <div id="eegStatus" class="info">EEG Status: Waiting for hardware</div>
            <div id="wellnessDisplay" class="info">Wellness Score: --</div>
            <div id="lastResponse" class="info">Last Response: None</div>
        </div>

        <!-- ========== ACTIVITY LOG ========== -->
        <div class="activity-log">
            <h3>📋 Activity Log</h3>
            <div id="activityLog">
                <div class="log-entry info">System initialized - Ready for EEG monitoring</div>
            </div>
            <div id="responseLog"><strong>Response Log</strong><br>Ready for real EEG data...<br></div>
        </div>
    </div>

    <script>
        // ========== CONFIGURATION - MATCHES N8N C CODE ========== //
        const CONFIG = {
            voiceWebhook: 'http://localhost:5678/webhook/shravya-voice',
            eegWebhook: 'http://localhost:5678/webhook/shravya-eeg-stream', // ✅ MATCHES C CODE
            updateInterval: 30000, // ✅ MATCHES TRANSMISSION_INTERVAL_S * 1000
            recordingDuration: 5000
        };

        // ========== STATE MANAGEMENT - NO HARDCODED VALUES ========== //
        let monitoringActive = false;
        let updateInterval = null;
        let sessionId = null;
        let realEEGDataReceived = false; // Track if we have real data

        // ========== DOM ELEMENTS ========== //
        const elements = {
            // Control buttons
            startBtn: document.getElementById('startMonitoringBtn'),
            stopBtn: document.getElementById('stopMonitoringBtn'),
            
            // Voice buttons
            greetingBtn: document.getElementById('startGreetingBtn'),
            listenBtn: document.getElementById('listenCmdBtn'),
            
            // Test buttons
            basicTestBtn: document.getElementById('testBasicEEGBtn'),
            stressTestBtn: document.getElementById('testHighStressBtn'),
            focusTestBtn: document.getElementById('testPerfectFocusBtn'),
            clearBtn: document.getElementById('clearLogBtn'),
            
            // Status displays
            wellnessScore: document.getElementById('wellnessScore'),
            focusLevel: document.getElementById('focusLevel'),
            stressLevel: document.getElementById('stressLevel'),
            calmLevel: document.getElementById('calmLevel'),
            flowState: document.getElementById('flowState'),
            connectionStatus: document.getElementById('connectionStatus'),
            samplingRate: document.getElementById('samplingRate'),
            
            // Detailed status
            connectionStatusDetailed: document.getElementById('connectionStatusDetailed'),
            eegStatus: document.getElementById('eegStatus'),
            wellnessDisplay: document.getElementById('wellnessDisplay'),
            lastResponse: document.getElementById('lastResponse'),
            
            // Logs
            activityLog: document.getElementById('activityLog'),
            responseLog: document.getElementById('responseLog'),
            responseAudio: document.getElementById('responseAudio')
        };

        // ========== UTILITY FUNCTIONS ========== //
        function logActivity(message, type = 'info') {
            const log = elements.activityLog;
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `${timestamp} - ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function logResponse(message, type = 'info') {
            const log = elements.responseLog;
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            log.innerHTML += `<span class="${colorClass}">${timestamp} - ${message}</span><br>`;
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(connection, eeg, wellness, response) {
            if (connection) elements.connectionStatusDetailed.textContent = `Connection Status: ${connection}`;
            if (eeg) elements.eegStatus.textContent = `EEG Status: ${eeg}`;
            if (wellness) elements.wellnessDisplay.textContent = `Wellness Score: ${wellness}`;
            if (response) elements.lastResponse.textContent = `Last Response: ${response}`;
        }

        // ========== FIXED: Handle both formats (HTML camelCase and C lowercase) ========== //
        function updateCognitiveStates(data) {
            const states = data.cognitive_states || data.cognitiveStates;
            
            if (states) {
                elements.focusLevel.textContent = states.focus?.toFixed(1) || '--';
                elements.stressLevel.textContent = states.stress?.toFixed(1) || '--';
                elements.calmLevel.textContent = states.calm?.toFixed(1) || '--';
                elements.flowState.textContent = (states.flowstate || states.flowState)?.toFixed(1) || '--';
            }

            // Handle wellness score
            if (data.wellnessAssessment?.overallScore || data.wellnessScore || data.wellness_score) {
                const score = data.wellnessAssessment?.overallScore || data.wellnessScore || data.wellness_score;
                elements.wellnessScore.textContent = parseFloat(score).toFixed(1);
                elements.wellnessScore.parentElement.className = score > 7 ? 'wellness-display pulse' : 'wellness-display';
            }

            // Handle sampling rate
            if (data.samplingRate || data.sampling_rate) {
                elements.samplingRate.textContent = `${data.samplingRate || data.sampling_rate} Hz`;
            }

            elements.connectionStatus.textContent = 'Connected';
            elements.connectionStatus.style.color = '#28a745';
        }

        // ========== EEG MONITORING FUNCTIONS ========== //
        async function startMonitoring() {
            if (monitoringActive) return;
            
            try {
                monitoringActive = true;
                sessionId = `shravya-session-${Date.now()}`;
                
                elements.startBtn.disabled = true;
                elements.stopBtn.disabled = false;
                elements.connectionStatus.textContent = 'Connecting...';
                elements.connectionStatus.style.color = '#ffc107';
                
                // Add visual feedback
                document.querySelector('.container').classList.add('monitoring-active');
                
                logActivity('Starting EEG monitoring session...', 'success');
                updateStatus('Connecting...', 'Initializing monitoring...', '--', '--');
                
                // ✅ Send START signal to N8N workflow
                await sendStartSignalToN8N();
                
                // Start continuous EEG data requests
                updateInterval = setInterval(requestEEGUpdate, CONFIG.updateInterval);
                
                elements.connectionStatus.textContent = 'Monitoring';
                elements.connectionStatus.style.color = '#28a745';
                updateStatus('Connected', 'Active monitoring', '--', 'Monitoring started');
                logActivity('EEG monitoring started - waiting for hardware data...', 'success');
                
            } catch (error) {
                logActivity(`Failed to start monitoring: ${error.message}`, 'error');
                updateStatus('Error', 'Failed to start', '--', 'Error');
                stopMonitoring();
            }
        }

        // ========== FIXED: Send START signal that matches N8N C format ========== //
        async function sendStartSignalToN8N() {
            const startSignal = {
                // ✅ EXACT MATCH with n8n_eeg_payload_t structure
                userid: 'shravya_user_001',  // ✅ MATCHES C CODE
                sessionid: sessionId,
                deviceid: 'SHRAVYA_EEG_001', // ✅ MATCHES C CODE  
                timestamp: new Date().toISOString(),
                action: 'START_MONITORING',
                
                // ✅ FIXED: Use lowercase field names to match C code
                cognitive_states: {  // ✅ FIXED: was "cognitiveStates"
                    focus: 0.0,      // ✅ START with 0 - wait for real data
                    stress: 0.0,
                    anxiety: 0.0,
                    fatigue: 0.0,
                    calm: 0.0,
                    flowstate: 0.0   // ✅ FIXED: was "flowState"
                },
                
                // ✅ FIXED: Match exact C code format
                frequency_analysis: {  // ✅ FIXED: was "frequencyAnalysis"
                    delta_power: 0.0,  // ✅ FIXED: was "deltapower"
                    theta_power: 0.0,  // ✅ FIXED: was "thetapower"
                    alpha_power: 0.0,  // ✅ FIXED: was "alphapower"
                    beta_power: 0.0,   // ✅ FIXED: was "betapower"
                    gamma_power: 0.0   // ✅ FIXED: was "gammapower"
                },
                
                // ✅ FIXED: Match exact C code format
                signal_quality: {      // ✅ FIXED: was "signalQuality"
                    snr_db: 0.0,       // ✅ FIXED: was "snrDb"
                    artifact_detected: false // ✅ FIXED: was "artifactDetected"
                },
                
                sampling_rate: 500 // ✅ MATCHES C CODE: 500 Hz from ADS1263
            };

            const response = await fetch(CONFIG.eegWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(startSignal)
            });

            if (!response.ok) {
                throw new Error(`N8N trigger failed: HTTP ${response.status}`);
            }

            logActivity('N8N workflow triggered - waiting for real EEG data...', 'success');
            logResponse('N8N workflow started - no hardcoded values', 'success');
            return await response.json();
        }

        // ========== FIXED: Wait for REAL data from hardware ========== //
        async function requestEEGUpdate() {
            if (!monitoringActive) return;

            try {
                // ✅ FIXED: Just ping the status - don't send fake data
                logActivity('Polling for real EEG data from hardware...', 'info');
                
                // ✅ NEW: Check if hardware is sending data
                const statusCheck = {
                    userid: 'shravya_user_001',
                    sessionid: sessionId,
                    deviceid: 'SHRAVYA_EEG_001',
                    timestamp: new Date().toISOString(),
                    action: 'STATUS_CHECK'
                };

                const response = await fetch(CONFIG.eegWebhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(statusCheck)
                });

                if (response.ok) {
                    const responseData = await response.text();
                    
                    // ✅ Try to parse real EEG data if available
                    try {
                        const realData = JSON.parse(responseData);
                        
                        // ✅ Check if this is real data from hardware (not echo)
                        if (realData.cognitive_states && realData.cognitive_states.focus !== undefined) {
                            realEEGDataReceived = true;
                            updateCognitiveStates(realData);
                            logActivity('Real EEG data received from hardware!', 'success');
                            logResponse(`Real data - Focus: ${realData.cognitive_states.focus}, Stress: ${realData.cognitive_states.stress}`, 'success');
                        } else {
                            logActivity('Hardware connected but no EEG data yet...', 'info');
                            logResponse('Waiting for real EEG stream from hardware...', 'info');
                        }
                    } catch (e) {
                        // Not JSON - just log status
                        logActivity('Monitoring active - waiting for EEG data stream...', 'info');
                        logResponse('Status: Monitoring active, waiting for hardware...', 'info');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }

            } catch (error) {
                logActivity(`EEG status check failed: ${error.message}`, 'error');
                logResponse(`Status check failed: ${error.message}`, 'error');
                updateStatus('Error', 'Update failed', '--', 'Error');
            }
        }

        function stopMonitoring() {
            monitoringActive = false;
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            elements.connectionStatus.textContent = 'Offline';
            elements.connectionStatus.style.color = '#dc3545';
            
            // Remove visual feedback
            document.querySelector('.container').classList.remove('monitoring-active');
            
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            updateStatus('Offline', 'Monitoring stopped', '--', 'Stopped');
            logActivity('EEG monitoring stopped', 'warning');
            logResponse('EEG monitoring stopped', 'warning');
            sessionId = null;
        }

        // ========== VOICE COMMAND FUNCTIONS ========== //
        async function startVoiceGreeting() {
            try {
                updateStatus('Testing...', 'Voice greeting...', '--', '--');
                logActivity('Starting voice greeting...', 'info');
                
                const response = await fetch(CONFIG.voiceWebhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: 'startup_greeting' })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    playAudioBlob(audioBlob);
                    updateStatus('Connected', 'Voice greeting - Success', '--', 'Audio played');
                    logActivity('Voice greeting successful', 'success');
                    logResponse('Voice greeting successful', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('Error', 'Voice greeting - Failed', '--', 'Error');
                logActivity(`Voice greeting failed: ${error.message}`, 'error');
                logResponse(`Voice greeting failed: ${error.message}`, 'error');
            }
        }

        async function startVoiceCommand() {
            try {
                updateStatus('Recording...', 'Voice command...', '--', '--');
                logActivity('Starting voice command recording...', 'info');
                logResponse('Recording for 5 seconds...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                let audioChunks = [];

                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    try {
                        const response = await fetch(CONFIG.voiceWebhook, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/octet-stream' },
                            body: audioBlob
                        });

                        if (response.ok) {
                            const responseAudioBlob = await response.blob();
                            playAudioBlob(responseAudioBlob);
                            updateStatus('Connected', 'Voice command - Success', '--', 'Audio processed');
                            logActivity('Voice command processed successfully', 'success');
                            logResponse('Voice command processed successfully', 'success');
                        } else {
                            throw new Error(`HTTP ${response.status}`);
                        }
                    } catch (error) {
                        updateStatus('Error', 'Voice command - Failed', '--', 'Error');
                        logActivity(`Voice command failed: ${error.message}`, 'error');
                        logResponse(`Voice command failed: ${error.message}`, 'error');
                    }
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), CONFIG.recordingDuration);
                
            } catch (error) {
                updateStatus('Error', 'Voice command - Failed', '--', 'Error');
                logActivity(`Voice command error: ${error.message}`, 'error');
                logResponse(`Voice command failed: ${error.message}`, 'error');
            }
        }

        function playAudioBlob(blob) {
            const audioUrl = URL.createObjectURL(blob);
            elements.responseAudio.src = audioUrl;
            elements.responseAudio.play();
        }

        // ========== FIXED: Test with C code compatible format ========== //
        async function testEEGData(testName, cognitiveStates) {
            const testData = {
                userid: 'test-user',           // ✅ MATCHES C CODE FORMAT
                sessionid: `test-${Date.now()}`,
                deviceid: 'SHRAVYA-TEST-DEVICE',
                timestamp: new Date().toISOString(),
                
                // ✅ FIXED: Use lowercase format to match C code
                cognitive_states: {
                    focus: parseFloat(cognitiveStates.focus) || 0,
                    stress: parseFloat(cognitiveStates.stress) || 0,
                    anxiety: parseFloat(cognitiveStates.anxiety) || 0,
                    fatigue: parseFloat(cognitiveStates.fatigue) || 0,
                    calm: parseFloat(cognitiveStates.calm) || 0,
                    flowstate: parseFloat(cognitiveStates.flowstate) || 0  // ✅ lowercase
                },
                
                frequency_analysis: {  // ✅ MATCHES C CODE
                    delta_power: 0.15,
                    theta_power: 0.23,
                    alpha_power: 0.42,
                    beta_power: 0.28,
                    gamma_power: 0.12
                },
                
                signal_quality: {      // ✅ MATCHES C CODE
                    snr_db: 18.5,
                    artifact_detected: false
                },
                
                sampling_rate: 500     // ✅ MATCHES C CODE
            };

            // Calculate wellness score
            testData.wellness_score = parseFloat((
                testData.cognitive_states.focus * 0.3 +
                testData.cognitive_states.calm * 0.2 +
                testData.cognitive_states.flowstate * 0.2 +
                (10 - testData.cognitive_states.stress) * 0.15 +
                (10 - testData.cognitive_states.anxiety) * 0.1 +
                (10 - testData.cognitive_states.fatigue) * 0.05
            ).toFixed(1));

            try {
                logActivity(`Running ${testName}...`, 'info');
                logResponse(`Testing: ${testName}`, 'info');
                
                const response = await fetch(CONFIG.eegWebhook, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    updateCognitiveStates(testData);
                    updateStatus('Connected', `${testName} - Success`, testData.wellness_score, 'Success');
                    logActivity(`${testName} completed successfully`, 'success');
                    logResponse(`${testName} - Wellness: ${testData.wellness_score}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                updateStatus('Error', `${testName} - Failed`, '--', 'Error');
                logActivity(`${testName} failed: ${error.message}`, 'error');
                logResponse(`${testName} failed: ${error.message}`, 'error');
            }
        }

        function clearLogs() {
            elements.activityLog.innerHTML = '<div class="log-entry info">System initialized - Ready for EEG monitoring</div>';
            elements.responseLog.innerHTML = '<strong>Response Log</strong><br>Log cleared - ready for real data...<br>';
            logActivity('Logs cleared', 'warning');
        }

        // ========== EVENT LISTENERS ========== //
        elements.startBtn.addEventListener('click', startMonitoring);
        elements.stopBtn.addEventListener('click', stopMonitoring);
        elements.greetingBtn.addEventListener('click', startVoiceGreeting);
        elements.listenBtn.addEventListener('click', startVoiceCommand);
        elements.clearBtn.addEventListener('click', clearLogs);

        // ========== FIXED: Test buttons with correct format ========== //
        elements.basicTestBtn.addEventListener('click', () => {
            testEEGData('Basic EEG Test', {
                focus: 6.5, stress: 3.2, anxiety: 2.1, 
                fatigue: 3.8, calm: 7.2, flowstate: 5.9  // ✅ lowercase
            });
        });

        elements.stressTestBtn.addEventListener('click', () => {
            testEEGData('High Stress Test', {
                focus: 2.1, stress: 8.7, anxiety: 7.9, 
                fatigue: 6.3, calm: 1.8, flowstate: 1.2  // ✅ lowercase
            });
        });

        elements.focusTestBtn.addEventListener('click', () => {
            testEEGData('Perfect Focus Test', {
                focus: 9.8, stress: 1.2, anxiety: 0.8, 
                fatigue: 1.1, calm: 9.5, flowstate: 9.7  // ✅ lowercase
            });
        });

        // ========== INITIALIZATION ========== //
        elements.stopBtn.disabled = true;
        logActivity('SHRAVYA Interface ready - NO hardcoded values', 'success');
        logActivity('All systems initialized - Ready for operation', 'info');
        logResponse('SHRAVYA EEG Interface ready', 'success');
        logResponse('Waiting for REAL EEG data from hardware...', 'info');

        // Add some visual flair on load
        setTimeout(() => {
            document.querySelector('.wellness-display').classList.add('pulse');
        }, 1000);
    </script>
</body>
</html>
