<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SHRAVYA AI Companion</title>
</head>
<body>
  <h3>SHRAVYA AI Companion</h3>
  <button id="startGreetingBtn">Start Greeting</button>
  <button id="listenCmdBtn">Listen to Command</button>
  <br /><br />
  <audio id="responseAudio" controls></audio>

  <script>
    const webhookUrl = 'http://localhost:5678/webhook/shravya-voice';

    // Send startup greeting text to webhook to receive SHRAVYA's greeting audio
    document.getElementById('startGreetingBtn').onclick = async () => {
      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: 'startup_greeting' }),
        });
        if (!response.ok) throw new Error('Network response was not ok');
        const audioBlob = await response.blob();
        playAudioBlob(audioBlob);
        console.log('Greeting audio played successfully');
      } catch (error) {
        console.error('Error fetching greeting audio:', error);
      }
    };

    // Record audio from microphone, send it to webhook, and play response
    document.getElementById('listenCmdBtn').onclick = async () => {
      try {
        // Request microphone permission and start recording
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        let audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          console.log('Recording stopped, sending audio to webhook');

          // Send audio blob to webhook as binary POST
          const response = await fetch(webhookUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/octet-stream' },
            body: audioBlob,
          });

          if (!response.ok) throw new Error('Network response was not ok');

          // Play audio response from webhook
          const responseAudioBlob = await response.blob();
          playAudioBlob(responseAudioBlob);
          console.log('Response audio played successfully');

          // Stop microphone stream
          stream.getTracks().forEach(track => track.stop());
        };

        audioChunks = [];
        mediaRecorder.start();
        console.log('Recording started');
        // Record for 5 seconds (adjustable)
        setTimeout(() => mediaRecorder.stop(), 5000);

      } catch (err) {
        console.error('Error during voice capture or sending:', err);
      }
    };

    // Helper function to play audio blob in the audio element
    function playAudioBlob(blob) {
      const audioElement = document.getElementById('responseAudio');
      const audioUrl = URL.createObjectURL(blob);
      audioElement.src = audioUrl;
      audioElement.play();
    }
  </script>
</body>
</html>
